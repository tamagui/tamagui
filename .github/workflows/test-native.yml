name: Native Tests (Detox)

on:
  push:
    branches:
      - main
      - appium
  pull_request:
    branches:
      - main
      - appium
  workflow_dispatch:

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  test_container_app_path: code/kitchen-sink

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # iOS Build & Test
  # ─────────────────────────────────────────────────────────────────────────────

  build-ios:
    name: Build iOS App
    uses: ./.github/workflows/build-ios-kitchensink-app.yml
    with:
      configuration: Debug
    secrets: inherit

  test-ios:
    name: iOS Detox Tests
    needs: build-ios
    runs-on: macos-14
    timeout-minutes: 45
    defaults:
      run:
        working-directory: ${{ env.test_container_app_path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Xcode version
        run: sudo xcode-select -s /Applications/Xcode_16.2.app

      - name: Restore Built App from Cache
        uses: actions/cache/restore@v4
        with:
          key: ${{ needs.build-ios.outputs.built-app-cache-key }}
          path: ${{ needs.build-ios.outputs.built-app-path }}
          fail-on-cache-miss: true

      - name: Install Dependencies
        uses: ./.github/actions/install
        with:
          workspace-focus: '@tamagui/kitchen-sink'

      - name: Install Detox CLI
        run: npm install -g detox-cli

      - name: Install applesimutils
        run: |
          brew tap wix/brew
          brew install applesimutils

      - name: Boot iOS Simulator
        id: boot-simulator
        working-directory: ${{ github.workspace }}
        run: |
          # Find iPhone 15 simulator
          DEVICE_ID=$(xcrun simctl list devices available -j | jq -r '
            .devices | to_entries[]
            | select(.key | contains("iOS"))
            | .value[]
            | select(.name == "iPhone 15")
            | .udid' | head -1)

          if [ -z "$DEVICE_ID" ]; then
            echo "iPhone 15 not found, using first available iPhone"
            DEVICE_ID=$(xcrun simctl list devices available -j | jq -r '
              .devices | to_entries[]
              | select(.key | contains("iOS"))
              | .value[]
              | select(.name | contains("iPhone"))
              | .udid' | head -1)
          fi

          echo "Booting simulator: $DEVICE_ID"
          xcrun simctl boot "$DEVICE_ID" || true
          xcrun simctl bootstatus "$DEVICE_ID" -b
          echo "simulator_udid=$DEVICE_ID" >> $GITHUB_OUTPUT

      - name: Install App on Simulator
        working-directory: ${{ github.workspace }}
        run: |
          xcrun simctl install booted "${{ needs.build-ios.outputs.built-app-path }}"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Run iOS Detox Tests
        env:
          # Point Detox to the cached app (CI uses different path than local dev)
          DETOX_IOS_APP_PATH: build/Build/Products/Debug-iphonesimulator/tamaguikitchensink.app
        run: |
          bun run ../packages/native-ci/src/run-detox-ios.ts --project-root "$PWD" --record-logs failing

      - name: Upload Detox Artifacts on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: detox-artifacts-ios
          path: ${{ env.test_container_app_path }}/e2e/artifacts/
          retention-days: 7
